<!DOCTYPE html>
<html>
<head>
    <title>Visual Sync Popup Test</title>
    <link rel="stylesheet" href="font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/groove_writer_orange.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 5px;
        }
        .test-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 3px;
            font-family: monospace;
        }
        .success {
            background: #e6ffe6;
            color: #006600;
        }
        .error {
            background: #ffe6e6;
            color: #cc0000;
        }
        .info {
            background: #e6f3ff;
            color: #0066cc;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 3px;
        }
        button:hover {
            background: #e9e9e9;
        }
        .test-btn {
            background: #2196F3;
            color: white;
            border-color: #0b7dda;
        }
    </style>
</head>
<body>
    <h1>Visual Sync Popup Test</h1>
    
    <div class="test-container">
        <div class="test-title">Visual Sync Configuration Popup Test</div>
        <p>Test if the visual sync popup opens and functions correctly:</p>
        
        <button class="test-btn" onclick="testShowPopup()">Show Visual Sync Popup</button>
        <button class="test-btn" onclick="testClosePopup()">Close Visual Sync Popup</button>
        <button onclick="testPopupElements()">Test Popup Elements</button>
        <button onclick="testSliderFunction()">Test Slider Function</button>
        
        <div class="status" id="status">Click buttons to test visual sync popup functionality</div>
    </div>

    <div class="test-container">
        <div class="test-title">Error Monitoring</div>
        <div class="status" id="errorStatus">No errors detected</div>
        <button onclick="clearErrors()">Clear Error Log</button>
    </div>

    <div class="test-container">
        <div class="test-title">Instructions</div>
        <p>To test the visual sync popup in the main application:</p>
        <ol>
            <li><strong>Open GrooveScribe:</strong> <button onclick="openMainApp()">Open Main App</button></li>
            <li><strong>Find metronome options:</strong> Look for the gear icon next to the metronome controls</li>
            <li><strong>Click metronome options:</strong> Right-click or click the gear icon</li>
            <li><strong>Select "Visual sync":</strong> This should open the visual sync configuration popup</li>
            <li><strong>Test the slider:</strong> Move the slider and observe the value changes</li>
            <li><strong>Test presets:</strong> Click the preset buttons (-100ms, -50ms, 0ms, 50ms, 100ms)</li>
            <li><strong>Test save as default:</strong> Check the checkbox and close the popup</li>
        </ol>
    </div>

    <!-- Include the visual sync popup HTML -->
    <div id="visualSyncConfiguration">
        <div id="visualSyncOutputText">
            Visual sync offset: <span id="visualSyncOffsetOutput">50 ms</span>
        </div>
        <div id="visualSyncDescription">
            Adjust timing to synchronize visual highlighting with audio playback.<br>
            <strong>Positive values:</strong> Visual appears earlier than audio<br>
            <strong>Negative values:</strong> Visual appears later than audio
        </div>
        <div id="visualSyncConfigurationSliders">
            <div id="visualSyncConfigurationOffsetLabel">Timing Offset (milliseconds)</div>
            <input type="range" min="-200" max="200" value="50" step="5" class="visualSyncRange" id="visualSyncOffset" oninput="updateSliderValue();">
        </div>
        <div id="visualSyncSaveDefault">
            <input type="checkbox" id="visualSyncSetAsDefault"><label for="visualSyncSetAsDefault">Save as default for future sessions</label>
        </div>
        <div id="visualSyncPresets">
            <strong>Presets:</strong>
            <button onclick="setPreset(-100)">-100ms</button>
            <button onclick="setPreset(-50)">-50ms</button>
            <button onclick="setPreset(0)">0ms</button>
            <button onclick="setPreset(50)">50ms</button>
            <button onclick="setPreset(100)">100ms</button>
        </div>
        <div id="visualSyncCloseButtonDiv">
            <button id="visualSyncConfigurationCloseButton" onclick="testClosePopup();">Done</button>
        </div>
    </div>

    <script src="js/groove_utils.js"></script>
    <script src="js/groove_writer.js"></script>
    <script>
        let errorLog = [];
        let myGrooveWriter = null;

        function updateStatus(message, className = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + className;
        }

        function updateErrorStatus() {
            const errorElement = document.getElementById('errorStatus');
            if (errorLog.length === 0) {
                errorElement.textContent = 'No errors detected';
                errorElement.className = 'status success';
            } else {
                errorElement.textContent = errorLog.slice(-3).join('\n');
                errorElement.className = 'status error';
            }
        }

        // Capture console errors
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            errorLog.push(`ERROR: ${new Date().toLocaleTimeString()} - ${message}`);
            updateErrorStatus();
            originalConsoleError.apply(console, args);
        };

        // Capture JavaScript errors
        window.addEventListener('error', function(e) {
            const message = `${e.message} at ${e.filename}:${e.lineno}`;
            errorLog.push(`JS ERROR: ${new Date().toLocaleTimeString()} - ${message}`);
            updateErrorStatus();
        });

        function clearErrors() {
            errorLog = [];
            updateErrorStatus();
        }

        function testShowPopup() {
            try {
                if (myGrooveWriter && typeof myGrooveWriter.show_VisualSyncConfiguration === 'function') {
                    myGrooveWriter.show_VisualSyncConfiguration();
                    updateStatus('✓ Visual sync popup opened successfully', 'success');
                } else {
                    // Direct popup test
                    const popup = document.getElementById('visualSyncConfiguration');
                    if (popup) {
                        popup.style.display = 'block';
                        updateStatus('✓ Popup shown directly (GrooveWriter not available)', 'info');
                    } else {
                        updateStatus('✗ Popup element not found', 'error');
                    }
                }
            } catch (error) {
                updateStatus(`✗ Error showing popup: ${error.message}`, 'error');
                errorLog.push(`CAUGHT: ${new Date().toLocaleTimeString()} - ${error.message}`);
                updateErrorStatus();
            }
        }

        function testClosePopup() {
            try {
                if (myGrooveWriter && typeof myGrooveWriter.close_VisualSyncConfiguration === 'function') {
                    myGrooveWriter.close_VisualSyncConfiguration();
                    updateStatus('✓ Visual sync popup closed successfully', 'success');
                } else {
                    // Direct popup test
                    const popup = document.getElementById('visualSyncConfiguration');
                    if (popup) {
                        popup.style.display = 'none';
                        updateStatus('✓ Popup hidden directly (GrooveWriter not available)', 'info');
                    } else {
                        updateStatus('✗ Popup element not found', 'error');
                    }
                }
            } catch (error) {
                updateStatus(`✗ Error closing popup: ${error.message}`, 'error');
            }
        }

        function testPopupElements() {
            const elements = [
                'visualSyncConfiguration',
                'visualSyncOffset',
                'visualSyncOffsetOutput',
                'visualSyncSetAsDefault',
                'visualSyncConfigurationCloseButton'
            ];
            
            const missing = elements.filter(id => !document.getElementById(id));
            
            if (missing.length === 0) {
                updateStatus('✓ All popup elements found', 'success');
            } else {
                updateStatus(`✗ Missing elements: ${missing.join(', ')}`, 'error');
            }
        }

        function testSliderFunction() {
            try {
                const slider = document.getElementById('visualSyncOffset');
                const output = document.getElementById('visualSyncOffsetOutput');
                
                if (slider && output) {
                    slider.value = 75;
                    updateSliderValue();
                    
                    if (output.textContent.includes('75')) {
                        updateStatus('✓ Slider function works correctly', 'success');
                    } else {
                        updateStatus('✗ Slider function not updating output', 'error');
                    }
                } else {
                    updateStatus('✗ Slider or output element not found', 'error');
                }
            } catch (error) {
                updateStatus(`✗ Error testing slider: ${error.message}`, 'error');
            }
        }

        function updateSliderValue() {
            const slider = document.getElementById('visualSyncOffset');
            const output = document.getElementById('visualSyncOffsetOutput');
            
            if (slider && output) {
                output.textContent = slider.value + ' ms';
            }
        }

        function setPreset(value) {
            const slider = document.getElementById('visualSyncOffset');
            if (slider) {
                slider.value = value;
                updateSliderValue();
            }
        }

        function openMainApp() {
            window.open('http://localhost:8888/GrooveScribe/', '_blank');
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            try {
                if (typeof GrooveWriter !== 'undefined') {
                    myGrooveWriter = new GrooveWriter();
                    updateStatus('GrooveWriter initialized. Ready to test visual sync popup.', 'success');
                } else {
                    updateStatus('GrooveWriter not available. Testing popup elements directly.', 'info');
                }
            } catch (error) {
                updateStatus('Error initializing GrooveWriter: ' + error.message, 'error');
            }
            
            updateErrorStatus();
            
            // Hide popup initially
            const popup = document.getElementById('visualSyncConfiguration');
            if (popup) {
                popup.style.display = 'none';
            }
        });
    </script>
</body>
</html>
